<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AR Jewelry Viewer</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; }
    canvas { display: block; }
    .ui {
      position: absolute;
      top: 10px; left: 10px;
      background: rgba(255,255,255,0.8);
      padding: 10px; border-radius: 6px;
    }
    .ui button {
      display: block;
      margin: 5px 0;
      padding: 8px 12px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="ui">
    <button onclick="setColor('#FFD700')">Gold</button>
    <button onclick="setColor('#C0C0C0')">Silver</button>
    <button onclick="setReflectiveGold()">Ultra Reflective Gold</button>
    <button onclick="setSilverMaterial()">Realistic Silver</button>
    <button onclick="setDiamondMaterial()">Enhanced Diamonds</button>
  </div>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.152.2/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    let scene, camera, renderer, model, textureLoader;

    init();
    loadModel();

    function init() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xf5f5f5);

      camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
      camera.position.set(0, 1, 3);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.0;
      renderer.outputEncoding = THREE.sRGBEncoding;
      document.body.appendChild(renderer.domElement);

      // Enhanced lighting setup
      const ambientLight = new THREE.AmbientLight(0x404040, 0.3);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(10, 10, 5);
      directionalLight.castShadow = true;
      directionalLight.shadow.mapSize.width = 2048;
      directionalLight.shadow.mapSize.height = 2048;
      scene.add(directionalLight);

      const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.5);
      directionalLight2.position.set(-10, -10, -5);
      scene.add(directionalLight2);

      // Enhanced HDR environment mapping for better reflections
      const envMapLoader = new THREE.CubeTextureLoader();
      const envMap = envMapLoader.load([
        'https://threejs.org/examples/textures/cube/Bridge2/posx.jpg',
        'https://threejs.org/examples/textures/cube/Bridge2/negx.jpg',
        'https://threejs.org/examples/textures/cube/Bridge2/posy.jpg',
        'https://threejs.org/examples/textures/cube/Bridge2/negy.jpg',
        'https://threejs.org/examples/textures/cube/Bridge2/posz.jpg',
        'https://threejs.org/examples/textures/cube/Bridge2/negz.jpg'
      ]);
      scene.environment = envMap;
      scene.background = envMap;

      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      textureLoader = new THREE.TextureLoader();

      window.addEventListener('resize', onWindowResize);
      animate();
    }

    function loadModel() {
      const loader = new GLTFLoader();
      loader.load('ring03.glb', gltf => {
        model = gltf.scene;
        
        // Apply smooth shading and enhanced materials
        model.traverse(child => {
          if (child.isMesh) {
            child.castShadow = true;
            child.receiveShadow = true;
            
            // Ensure smooth shading
            if (child.geometry) {
              child.geometry.computeVertexNormals();
            }
            
            // Determine if this is a diamond or metal based on material name or geometry
            const isDiamond = child.name.toLowerCase().includes('diamond') || 
                             child.name.toLowerCase().includes('gem') ||
                             child.name.toLowerCase().includes('stone') ||
                             (child.material && child.material.name && 
                              child.material.name.toLowerCase().includes('diamond'));
            
            if (isDiamond) {
              // Enhanced diamond material
              child.material = new THREE.MeshPhysicalMaterial({
                color: 0xffffff,
                metalness: 0.0,
                roughness: 0.0,
                transmission: 0.95,
                transparent: true,
                opacity: 0.9,
                reflectivity: 1.0,
                refractionRatio: 0.42,
                envMapIntensity: 2.0,
                clearcoat: 1.0,
                clearcoatRoughness: 0.0,
                ior: 2.42,
                thickness: 0.5,
                attenuationDistance: 0.5,
                attenuationColor: new THREE.Color(0xffffff)
              });
            } else {
              // Enhanced metal material
              child.material = new THREE.MeshStandardMaterial({
                color: 0xFFD700,
                metalness: 1.0,
                roughness: 0.05,
                envMapIntensity: 2.5
              });
            }
          }
        });
        
        scene.add(model);
      });
    }

    function setColor(hex) {
      if (!model) return;
      model.traverse(child => {
        if (child.isMesh && !isDiamondMesh(child)) {
          child.material.map = null;
          child.material.color.set(hex);
          child.material.metalness = 1.0;
          child.material.roughness = 0.05;
          child.material.envMapIntensity = 2.5;
          child.material.needsUpdate = true;
        }
      });
    }

    function isDiamondMesh(child) {
      return child.name.toLowerCase().includes('diamond') || 
             child.name.toLowerCase().includes('gem') ||
             child.name.toLowerCase().includes('stone') ||
             (child.material && child.material.name && 
              child.material.name.toLowerCase().includes('diamond'));
    }

    function setTexture(path) {
      if (!model) return;
      const tex = textureLoader.load(path);
      model.traverse(child => {
        if (child.isMesh) {
          child.material.map = tex;
          child.material.color.set('#ffffff');
          child.material.needsUpdate = true;
        }
      });
    }

    function setSilverMaterial() {
      if (!model) return;
      
      // Load all metal textures
      const baseColor = textureLoader.load('Metal048A_1K-JPG_Color.jpg');
      const metalness = textureLoader.load('Metal048A_1K-JPG_Metalness.jpg');
      const roughness = textureLoader.load('Metal048A_1K-JPG_Roughness.jpg');
      const normal = textureLoader.load('Metal048A_1K-JPG_NormalGL.jpg');
      
      model.traverse(child => {
        if (child.isMesh) {
          // Create a new MeshStandardMaterial with PBR properties
          child.material = new THREE.MeshStandardMaterial({
            map: baseColor,
            metalnessMap: metalness,
            roughnessMap: roughness,
            normalMap: normal,
            metalness: 1.0,  // Fully metallic
            roughness: 0.2,  // Slightly rough for realistic silver
            color: '#C0C0C0'  // Silver tint
          });
        }
      });
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }

    function setDiamondMaterial() {
      if (!model) return;
      
      model.traverse(child => {
        if (child.isMesh && isDiamondMesh(child)) {
          child.material = new THREE.MeshPhysicalMaterial({
            color: 0xffffff,
            metalness: 0.0,
            roughness: 0.0,
            transmission: 0.98,
            transparent: true,
            opacity: 0.95,
            reflectivity: 1.0,
            refractionRatio: 0.42,
            envMapIntensity: 3.0,
            clearcoat: 1.0,
            clearcoatRoughness: 0.0,
            ior: 2.42,
            thickness: 0.3,
            attenuationDistance: 0.3,
            attenuationColor: new THREE.Color(0xffffff),
            side: THREE.DoubleSide
          });
        }
      });
    }

    function setReflectiveGold() {
      if (!model) return;
      
      model.traverse(child => {
        if (child.isMesh && !isDiamondMesh(child)) {
          child.material = new THREE.MeshStandardMaterial({
            color: 0xFFD700,
            metalness: 1.0,
            roughness: 0.02,
            envMapIntensity: 3.0
          });
        }
      });
    }

    // Expose functions globally
    window.setColor = setColor;
    window.setTexture = setTexture;
    window.setSilverMaterial = setSilverMaterial;
    window.setDiamondMaterial = setDiamondMaterial;
    window.setReflectiveGold = setReflectiveGold;
  </script>
</body>
</html>